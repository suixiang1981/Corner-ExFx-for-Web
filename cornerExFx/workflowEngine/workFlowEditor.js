var __extends=this&&this.__extends||function(){var i=function(t,e){i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)if(e.hasOwnProperty(o))t[o]=e[o]};return i(t,e)};return function(t,e){i(t,e);function o(){this.constructor=t}t.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}();define(["require","exports","../core/displayObject","./workFlowEngine","../containers/scrollPanel/scrollPanel","../core/util","../mvvm/dataForm/dataForm","../controls/form/form","../core/arrayCollection","./workFlowSetpTitle","../controls/button/button","../core/fXEvent","../controls/messageBox/messageBox","./workFlowEngineGoBackDialog","../core/dictionary","../mvvm/mvvmBase","./workFlowList","../controls/progress/progress"],function(t,e,o,p,l,v,F,k,n,I,s,r,a,f,u,g,c,_){"use strict";Object.defineProperty(e,"__esModule",{value:true});var i=function(o){__extends(i,o);function i(t){var e=o.call(this)||this;e._dataForm=null;e.buttonSave=new s.Button;e.buttonSubmit=new s.Button;e.buttonGoback=new s.Button;e.buttonPrint=new s.Button;e.listTitle=new n.ArrayCollection;e._listData=new n.ArrayCollection;e.scrollPanel=new l.ScrollPanel;e.timerH=-1;e.stepI=0;e.isStartStep=false;e.isLoading=false;e.timerResizeH=-1;e.toBottom=false;e.timerScrollH=-1;if(!i.workFlowEditorIsCSSLoaded){i.workFlowEditorIsCSSLoaded=true;Loader.loadCSS("cornerExFx/workflowEngine/skins/"+v.Util.skin+"/workFlowEditor.css")}e.element.className="workFlowEditorBody";e.element.innerHTML=Loader.loadTXT("cornerExFx/workflowEngine/skins/workFlowEditor.html",true);e.workFlowEditorBottom=v.Util.getElementByClass("workFlowEditorBottom",e.element);e._workFlowInfo=t;e.scrollPanel.element.style.transform="top, linear 200ms";e.buttonGoback.label="退回";e.buttonSave.label="保存";e.buttonSubmit.label="提交";e.buttonPrint.label="打印";v.Util.appendDisplayObject(e.workFlowEditorBottom,e.buttonGoback);v.Util.appendDisplayObject(e.workFlowEditorBottom,e.buttonSubmit);v.Util.appendDisplayObject(e.workFlowEditorBottom,e.buttonSave);v.Util.appendDisplayObject(e.workFlowEditorBottom,e.buttonPrint);e.buttonGoback.height=30;e.buttonSubmit.height=30;e.buttonSave.height=30;e.buttonPrint.height=30;e.buttonGoback.bottom=5;e.buttonSubmit.bottom=5;e.buttonSave.bottom=5;e.buttonPrint.bottom=5;e.buttonGoback.width=150;e.buttonSubmit.width=150;e.buttonSave.width=150;e.buttonPrint.width=150;e.buttonGoback.element.style.left="50%";e.buttonSave.element.style.left="50%";e.buttonSubmit.element.style.left="50%";e.buttonPrint.element.style.left="50%";e.buttonSave.addEventListener(r.FXMouseEvent.Click,function(t){e.dataForm.verify();e.save(e.buttonSave)});e.buttonSubmit.addEventListener(r.FXMouseEvent.Click,function(t){e.submit()});e.buttonGoback.addEventListener(r.FXMouseEvent.Click,function(t){e.goBack()});return e}Object.defineProperty(i.prototype,"dataForm",{get:function(){return this._dataForm},enumerable:true,configurable:true});i.prototype.hideInfo=function(){if(this.info!=null){this.info.style.visibility="hidden";this.scrollPanel.top=0}};i.prototype.showInfo=function(t,e){if(this.info==null){this.info=document.createElement("div");this.info.className="workFlowInfoBar";this.info.innerHTML=Loader.loadTXT("cornerExFx/workflowEngine/skins/workFlowInfoBar.html",true);this.workFlowInfoBarLabel=v.Util.getElementByClass("workFlowInfoBarLabel",this.info);this.workFlowInfoBarLink=v.Util.getElementByClass("workFlowInfoBarLink",this.info);if(!i.workFlowInfoIsCSSLoaded){i.workFlowInfoIsCSSLoaded=true;Loader.loadCSS("cornerExFx/workflowEngine/skins/"+v.Util.skin+"/workFlowInfoBar.css")}}this.element.appendChild(this.info);this.info.style.visibility="visible";this.workFlowInfoBarLabel.textContent=t;this.workFlowInfoBarLink.textContent=e};i.prototype.close=function(){if(this.timerH!=-1){clearInterval(this.timerH);this.timerH=-1;var t=this._workFlowInfo.stepList.getItemAt(0);p.WorkFlowEngine.close(t.stepId,t.formId,t.formYear,t.formMonth,t.port)}};i.prototype.setData=function(t,e){if(e===void 0){e=-1}var o;if(e<0||e>this._listData.count){o=this._listData.getItemAt(this._listData.count-1)}else{o=this._listData.getItemAt(e)}for(var i=0;i<t.keys.length;i++){var l=t.keys[i];o.xmlDataProvider.setAttribute(l,t.getValue(l))}o.xmlDataProvider=o.xmlDataProvider};i.prototype.getData=function(t){if(t===void 0){t=-1}var e;if(t<0||t>this._listData.count){e=this._listData.getItemAt(this._listData.count-1)}else{e=this._listData.getItemAt(t)}var o=new u.Dictionary;for(var i=0;i<e.xmlDataProvider.attributes.length;i++){var l=e.xmlDataProvider.attributes.item(i);o.add(l.name,l.value)}return o};i.prototype.setFieldEnabled=function(t,e,o){if(o===void 0){o=-1}var i;if(o<0||o>this._listData.count){i=this._listData.getItemAt(this._listData.count-1)}else{i=this._listData.getItemAt(o)}for(var l=0;l<i.fields.count;l++){var n=i.fields.getItemAt(l);if(n.field==t){n.enabled=e}}};i.prototype.setFieldVisible=function(t,e,o){if(o===void 0){o=-1}var i;if(o<0||o>this._listData.count){i=this._listData.getItemAt(this._listData.count-1)}else{i=this._listData.getItemAt(o)}for(var l=0;l<i.fields.count;l++){var n=i.fields.getItemAt(l);if(n.field==t){n.visible=e}}i.refresh()};Object.defineProperty(i.prototype,"workFlowInfo",{get:function(){return this._workFlowInfo},enumerable:true,configurable:true});Object.defineProperty(i.prototype,"listDataForm",{get:function(){return this._listData},enumerable:true,configurable:true});i.prototype.loadData=function(t){if(t===void 0){t=null}if(t!=null){this._workFlowInfo=t}this.loadControls()};i.prototype.goBack=function(){var o=this;if(this.workFlowEngineGoBackDialog==null){this.workFlowEngineGoBackDialog=new f.WorkFlowEngineGoBackDialog;v.Util.appendDisplayObject(document.body,this.workFlowEngineGoBackDialog)}this.workFlowEngineGoBackDialog.goBackEditorFunction=function(){if(o.goBackEditorFunction!=null){return o.goBackEditorFunction(o.workFlowInfo)}else{return null}};this.workFlowEngineGoBackDialog.loadEditor();this.workFlowEngineGoBackDialog.showDialog();this.workFlowEngineGoBackDialog.goBackCallback=function(t){if(t==""||t==null){return}o.buttonGoback.enabled=false;var e=o._workFlowInfo.stepList.getItemAt(o._workFlowInfo.stepList.count-1);p.WorkFlowEngine.goBack(e.stepId,e.formId,e.formYear,e.formMonth,t,function(t){o.buttonGoback.enabled=true;if(t){a.MessageBox.show("已完成退回!","提交",a.MessageBoxButtons.OK,a.MessageBoxIcon.Information);o.update()}else{a.MessageBox.show("无法完成退回!","错误",a.MessageBoxButtons.OK,a.MessageBoxIcon.Error)}})}};i.prototype.submit=function(){var e=this;this.dataForm.verify();if(this.dataForm.verified){a.MessageBox.show("请确认是否提交。","提交",a.MessageBoxButtons.YesNo,a.MessageBoxIcon.Information,function(t){if(t==a.MessageBoxButton.Yes){e.save(e.buttonSubmit,function(){e.buttonSubmit.enabled=false;var t=e._workFlowInfo.stepList.getItemAt(e._workFlowInfo.stepList.count-1);p.WorkFlowEngine.submit(t.stepId,t.formId,t.formYear,t.formMonth,function(t){e.buttonSubmit.enabled=true;if(t){a.MessageBox.show("已完成提交!","提交",a.MessageBoxButtons.OK,a.MessageBoxIcon.Information);e.update()}else{a.MessageBox.show("无法完成提交!","错误",a.MessageBoxButtons.OK,a.MessageBoxIcon.Error)}})})}})}};i.prototype.update=function(){var e=this;var t=this._workFlowInfo.stepList.getItemAt(this._workFlowInfo.stepList.count-1);p.WorkFlowEngine.load(t.stepId,t.formId,t.formYear,t.formMonth,function(t){e._workFlowInfo=t;e.loadControls()},true,t.port);c.WorkFlowList.loadData(this._workFlowInfo)};i.prototype.save=function(n,s){var r=this;if(s===void 0){s=null}var t=this._listData.getItemAt(this._listData.count-1);t.verify();n.enabled=false;var a=this._workFlowInfo.stepList.getItemAt(this._workFlowInfo.stepList.count-1);var e=new u.Dictionary;for(var o=0;o<a.dataElement.attributes.length;o++){var i=a.dataElement.attributes.item(o);e.add(i.name,i.value)}p.WorkFlowEngine.save(a.stepId,a.formId,a.formYear,a.formMonth,e,function(t,e,o,i){if(t!=null){a.formId=e;var l=r.listTitle.getItemAt(r.listTitle.count-1);l.editLabel=i+" 编辑于 "+v.Util.dateToString(t,v.DateFormat.Default,v.DateDataType.DateTime);c.WorkFlowList.loadData(r._workFlowInfo)}n.enabled=true;if(s!=null)s()},null)};i.prototype.loadControlI=function(e){var i=this;var t=false;if(e<this._workFlowInfo.stepList.count){_.Progress.show(e+1+"/"+this._workFlowInfo.stepList.count,e*100/this._workFlowInfo.stepList.count);var o=false;var l=this._workFlowInfo.stepList.getItemAt(e);if(l.visible){var n=void 0;if(e<this.listTitle.count){n=this.listTitle.getItemAt(e)}else{n=new I.WorkFlowStepTitle;this.listTitle.addItem(n);this.scrollPanel.addChild(n)}var s=void 0;if(l.state!=p.WorkFlowState.GOBACK){if(e+1<this._workFlowInfo.stepList.count){s=this._workFlowInfo.stepList.getItemAt(e+1)}if(s!=null){if(s.state==p.WorkFlowState.GOBACK){n.color="#CCCCCC";o=true}else{if(!this.isStartStep){this.isStartStep=true;t=true}}}else{if(!this.isStartStep){this.isStartStep=true;t=true}}}else{var r=void 0;if(e+2<this._workFlowInfo.stepList.count){r=this._workFlowInfo.stepList.getItemAt(e+2)}if(r!=null){if(r.state==p.WorkFlowState.GOBACK){n.color="#CCCCCC";o=true}else{n.color="#CCCC00"}}else{n.color="#CCCC00"}}if(!o){if(!t){var a=0;for(var f=e+1;f<this._workFlowInfo.stepList.count;f++){var u=this._workFlowInfo.stepList.getItemAt(f);if(u.visible){a++;if(a>1){break}}}t=a<=1}}n.element.style.transition="top linear 200ms";this.stepI++;n.number=this.stepI;n.titleLabel=l.stepLabel;n.editLabel=l.userLabel+(l.updateTime==null?" 创建于 "+v.Util.dateToString(l.createTime,v.DateFormat.Default,v.DateDataType.DateTime):" 编辑于 "+v.Util.dateToString(l.updateTime,v.DateFormat.Default,v.DateDataType.DateTime));var c;if(e<this._listData.count){c=this._listData.getItemAt(e);c.removeAllEventListener(k.FxFormEvent.Resize);c.removeAllEventListener(g.FxMVVMEvent.Load)}else{c=new F.DataForm(l.formName,true,null,false,false);this._listData.addItem(c);this.scrollPanel.addChild(c)}n.expandFunction=function(t){i.formDataResize()};n.expand=t;c.element.style.transition="top linear 200ms";c.left=10;c.right=10;c.addEventListener(k.FxFormEvent.Resize,function(t){i.formDataResize()});c.addEventListener(g.FxMVVMEvent.Load,function(t){i.loadControlI(e+1)});if(l.state==p.WorkFlowState.GOBACK){var m=new g.MVVMListInfo;var d=new g.MVVMField;d.label="退回意见";d.controlPercentWidth=100;d.controlHeight=60;d.controlType=g.MVVMControlType.MultilineText;d.enabled=false;d.name="label";d.isView=true;d.isEdit=true;d.isAdd=true;m.labelField=d;c.dataFunction=function(t){var e=v.Util.stringToXml("<data/>");e.documentElement.setAttribute("label",l.context);return e.documentElement};c.loadFromMVVMListInfo(m)}else{c.dataFunction=function(t){for(var e=0;e<i._workFlowInfo.stepList.count;e++){var o=i._workFlowInfo.stepList.getItemAt(e);if(o.formName==c.listDataName){if(o.formId==t){return o.dataElement}}}return null};c.load(l.formId,l.formYear,l.formMonth)}if(e==this._workFlowInfo.stepList.count-1){if(l.state==p.WorkFlowState.COMPLETE||l.state==p.WorkFlowState.SUBMIT||l.users.indexOf(p.WorkFlowEngine.userId)<0){this.hideInfo();c.enabled=false;this.close()}else{if(this._workFlowInfo.readOnly){c.enabled=false;this.showInfo("当前流程正在被 "+this._workFlowInfo.editingUserLabel+" 编辑，此处以只读方式打开。","点击这里刷新");this.workFlowInfoBarLink.onclick=function(){if(i._workFlowInfo.stepList.count>0){var t=i._workFlowInfo.stepList.getItemAt(0);p.WorkFlowEngine.load(t.stepId,t.formId,t.formYear,t.formMonth,function(t){i.loadData(t)})}}}else{this.hideInfo();this.buttonGoback.enabled=l.goBackEnabled&&this._workFlowInfo.stepList.getItemAt(0).stepId!=l.stepId;c.enabled=true;this._dataForm=c;if(this.timerH==-1){this.timerH=setInterval(function(){if(i._workFlowInfo.stepList.count>0){var t=i._workFlowInfo.stepList.getItemAt(0);p.WorkFlowEngine.editHeartbeat(t.stepId,t.formId,t.formYear,t.formMonth,t.port)}},5e3)}}}c.callFunction=function(t,e){if(i.callFunction!=null){i.callFunction(t,l,i._workFlowInfo,e)}};c.browseFieldOpenFunction=function(t,e){if(i.browseFieldOpenFunction!=null){i.browseFieldOpenFunction(t,l,i._workFlowInfo,e)}};c.browseFieldSelectedFunction=function(t){if(i.browseFieldSelectedFunction!=null){return i.browseFieldSelectedFunction(l,i._workFlowInfo,t)}return null}}else{c.enabled=false}}else{var n=void 0;if(e<this.listTitle.count){}else{n=new I.WorkFlowStepTitle;this.listTitle.addItem(n)}var h=void 0;if(e<this._listData.count){h=this._listData.getItemAt(e);h.removeAllEventListener(k.FxFormEvent.Resize);h.removeAllEventListener(g.FxMVVMEvent.Load)}else{h=new F.DataForm(l.formName);this._listData.addItem(h)}this.loadControlI(e+1)}}else{var w=new L;w.type=L.Load;w.target=this;this.dispatchEvent(w);var b=this._workFlowInfo.stepList.getItemAt(this._workFlowInfo.stepList.count-1);if(b.state==p.WorkFlowState.COMPLETE||b.state==p.WorkFlowState.SUBMIT||b.users.indexOf(p.WorkFlowEngine.userId)<0){this.scrollPanel.top=0;this.buttonGoback.visible=false;this.buttonSave.visible=false;this.buttonSubmit.visible=false;if(this.buttonPrint.visible){this.scrollPanel.bottom=45;this.buttonPrint.element.style.marginLeft="-75px"}else{this.scrollPanel.bottom=0}}else{if(this._workFlowInfo.readOnly){this.scrollPanel.top=30;this.buttonGoback.visible=false;this.buttonSave.visible=false;this.buttonSubmit.visible=false;if(this.buttonPrint.visible){this.scrollPanel.bottom=45;this.buttonPrint.element.style.marginLeft="-75px"}else{this.scrollPanel.bottom=0}}else{this.scrollPanel.top=0;this.scrollPanel.bottom=45;this.buttonGoback.visible=true;this.buttonSave.visible=true;this.buttonSubmit.visible=true;if(this.buttonPrint.visible){this.buttonSubmit.element.style.marginLeft="-307.5px";this.buttonGoback.element.style.marginLeft="-152.5px";this.buttonSave.element.style.marginLeft="2.5px";this.buttonPrint.element.style.marginLeft="157.5px"}else{this.buttonSubmit.element.style.marginLeft="-230px";this.buttonGoback.element.style.marginLeft="-75px";this.buttonSave.element.style.marginLeft="80px"}}}this.isLoading=false;this.toBottom=true;this.formDataResize();_.Progress.hide()}};i.prototype.loadControls=function(){this.stepI=0;this.isLoading=true;this.scrollPanel.element.style.left="-100000px";this._dataForm=null;this.scrollPanel.percentWidth=100;this.scrollPanel.top=0;this.scrollPanel.bottom=45;v.Util.appendDisplayObject(this.element,this.scrollPanel);for(var t=this._workFlowInfo.stepList.count;t<this.listTitle.count;t++){var e=this.listTitle.getItemAt(0);this.listTitle.removeItem(e);this.scrollPanel.removeChild(e)}for(var t=this._workFlowInfo.stepList.count;t<this._listData.count;t++){var o=this._listData.getItemAt(0);this._listData.removeItem(o);this.scrollPanel.removeChild(o);o.dataFunction=null;o.removeAllEventListener(g.FxMVVMEvent.Load)}t=0;this.loadControlI(t)};i.prototype.formDataResize=function(){var l=this;if(this.isLoading){return}if(this.timerResizeH!=-1){clearTimeout(this.timerResizeH)}this.timerResizeH=setTimeout(function(){l.timerResizeH=-1;var t=0;for(var e=0;e<l.listTitle.count;e++){var o=l.listTitle.getItemAt(e);o.top=t+5;t+=40;var i=l._listData.getItemAt(e);t+=5;if(o.expand){i.top=t;t+=i.height}else{i.top=-1e4}}l.scrollPanel.panel.style.height=t+5+"px";l.scroll()},200)};i.prototype.scroll=function(){var l=this;if(this.timerScrollH!=-1){clearTimeout(this.timerScrollH)}this.timerScrollH=setTimeout(function(){l.timerScrollH=-1;var t=0;var e=0;var o=l.listTitle.getItemAt(l.listTitle.count-1);e=o.top;t=e+45;var i=l._listData.getItemAt(l.listTitle.count-1);if(o.expand){t+=i.height}if(l.scrollPanel.vScroller!=null){if(l.scrollPanel.height<t+5){if(l.toBottom){l.toBottom=false;if(t+5-(e-5)>=l.scrollPanel.height){l.scrollPanel.vScroller.value=(e-5)/l.scrollPanel.lineHeight}else{l.scrollPanel.vScroller.value=(5+t-l.scrollPanel.height)/l.scrollPanel.lineHeight}}}else{l.scrollPanel.vScroller.value=0}}l.scrollPanel.element.style.left="0px";if(l.scrollPanel.bottom>0){l.workFlowEditorBottom.style.visibility="visible";l.workFlowEditorBottom.style.display="inline"}else{l.workFlowEditorBottom.style.visibility="hidden";l.workFlowEditorBottom.style.display="none"}},100)};i.workFlowInfoIsCSSLoaded=false;i.workFlowEditorIsCSSLoaded=false;return i}(o.DisplayObject);e.WorkFlowEditor=i;var L=function(t){__extends(e,t);function e(){return t.call(this)||this}e.Load="Load";return e}(r.FXEvent);e.FxWorkFlowEditorEvent=L});