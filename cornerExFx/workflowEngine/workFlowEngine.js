define(["require","exports","../controls/progress/progress","../core/util","../communication/contentType","../communication/httpClient","../core/dictionary","../core/arrayCollection"],function(t,e,g,f,c,E,a,n){"use strict";Object.defineProperty(e,"__esModule",{value:true});var i=function(){function d(){}d.getfirstStep=function(u,t,e){if(t===void 0){t=true}if(e===void 0){e=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(e);var m=true;if(t){if(d.firstStepListCache.containsKey(this.userId)){if(u!=null){m=false;u(d.firstStepListCache.getValue(this.userId))}}}if(m){g.Progress.show("加载起始步骤...",-1);var n=f.Util.stringToXml("<loadList/>");n.documentElement.setAttribute("name","workFlowEngine.firstStepList");n.documentElement.setAttribute("where","userId='"+d.userId.toString()+"'");d.httpClient.post(f.Util.xmlToString(n),c.ContentType.TextXML,function(t){g.Progress.hide();var e=f.Util.stringToXml(t);var n=new a.Dictionary;if(f.Util.getElementBooleanAttribute(e.documentElement,"return",false)){var i=f.Util.getElementChildrenNamedItem(e.documentElement,"data");for(var l=0;l<i.childNodes.length;l++){var r=i.childNodes.item(l);if(r.nodeType==1){var o=r;var s=new p;s.stepId=f.Util.getElementStringAttribute(o,"id");s.stepLabel=f.Util.getElementStringAttribute(o,"label");s.workFlowId=f.Util.getElementStringAttribute(o,"workFlowId");s.workFlowLabel=f.Util.getElementStringAttribute(o,"workFlowLabel");n.add(s.stepId,s)}}}d.firstStepListCache.add(d.userId,n);if(u!=null){m=false;u(n)}})}};d.goBack=function(t,e,n,i,l,r,o){if(o===void 0){o=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(o);var s;g.Progress.show("退回...",-1);s=f.Util.stringToXml("<workFlowEngine.goBack><data/></workFlowEngine.goBack>");s.documentElement.setAttribute("stepId",t);s.documentElement.setAttribute("formId",e);s.documentElement.setAttribute("formYear",n.toString());s.documentElement.setAttribute("formMonth",i.toString());if(this.goBackFunction!=null){l=this.goBackFunction(t,e,n,i,l);if(l==null){l=""}}s.documentElement.setAttribute("text",l);d.httpClient.post(f.Util.xmlToString(s),c.ContentType.TextXML,function(t){var e=null;var n=f.Util.stringToXml(t);if(r!=null){r(f.Util.getElementBooleanAttribute(n.documentElement,"return",false))}g.Progress.hide()})};d.submit=function(t,e,n,i,l,r){if(r===void 0){r=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(r);var o;g.Progress.show("提交...",-1);o=f.Util.stringToXml("<workFlowEngine.submit><data/></workFlowEngine.submit>");o.documentElement.setAttribute("stepId",t.toString());o.documentElement.setAttribute("formId",e.toString());o.documentElement.setAttribute("formYear",n.toString());o.documentElement.setAttribute("formMonth",i.toString());if(this.submitFunciont!=null){var s=this.submitFunciont(t,e,n,i);var u=f.Util.getElementChildrenNamedItem(o.documentElement,"data");if(s!=null){for(var m=0;m<s.keys.length;m++){var a=s.keys[m];u.setAttribute(a,s.getValue(a))}}}d.httpClient.post(f.Util.xmlToString(o),c.ContentType.TextXML,function(t){var e=null;var n=f.Util.stringToXml(t);if(l!=null){l(f.Util.getElementBooleanAttribute(n.documentElement,"return",false))}g.Progress.hide()})};d.save=function(t,e,n,i,l,r,o){if(o===void 0){o=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(o);var s;g.Progress.show("保存...",-1);s=f.Util.stringToXml("<workFlowEngine.save><data/></workFlowEngine.save>");s.documentElement.setAttribute("stepId",t.toString());s.documentElement.setAttribute("formId",e.toString());s.documentElement.setAttribute("formYear",n.toString());s.documentElement.setAttribute("formMonth",i.toString());var u=s.documentElement.firstChild;if(this.saveFunciont!=null){l=this.saveFunciont(t,e,n,i,l)}if(l!=null){for(var m=0;m<l.keys.length;m++){var a=l.keys[m];u.setAttribute(a,l.getValue(a))}d.httpClient.post(f.Util.xmlToString(s),c.ContentType.TextXML,function(t){var e=null;var n=f.Util.stringToXml(t);if(f.Util.getElementBooleanAttribute(n.documentElement,"return",false)){if(r!=null){r(f.Util.stringToDate(f.Util.getElementStringAttribute(n.documentElement,"updateTime")),f.Util.getElementStringAttribute(n.documentElement,"formId"),f.Util.getElementStringAttribute(n.documentElement,"userId"),f.Util.getElementStringAttribute(n.documentElement,"userLabel"))}}else{if(r!=null){r(null,null,null,null)}}g.Progress.hide()})}else{if(r!=null){r(null,null,null,null)}g.Progress.hide()}};d.loadStepList=function(l,e){var r=this;if(e===void 0){e=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(e);if(this.stepList==null){this.stepList=[];this.loadStepBaseList(function(t){r.stepList=t;r.loadStepList(l,e)},e)}else{var t=[];for(var n=0;n<this.stepList.length;n++){t.push(this.stepList[n].stepId)}var i=f.Util.stringToXml("<workFlowEngine.stepNumberList/>");i.documentElement.setAttribute("id",t.join(";"));d.httpClient.post(f.Util.xmlToString(i),c.ContentType.TextXML,function(t){var e=f.Util.stringToXml(t);if(f.Util.getElementBooleanAttribute(e.documentElement,"return",false)){var n=f.Util.getElementStringAttribute(e.documentElement,"value","").split(";");if(n.length==r.stepList.length){for(var i=0;i<r.stepList.length;i++){r.stepList[i].number=Number(n[i])}}l(r.stepList)}})}};d.loadStepBaseList=function(m,t){if(t===void 0){t=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(t);g.Progress.show("加载流程步骤...",-1);var e=f.Util.stringToXml("<loadList/>");e.documentElement.setAttribute("name","workFlowEngine.stepUserList");e.documentElement.setAttribute("where","userId='"+d.userId.toString()+"'");d.httpClient.post(f.Util.xmlToString(e),c.ContentType.TextXML,function(t){var e=null;var n=f.Util.stringToXml(t);var i=new Array;if(f.Util.getElementBooleanAttribute(n.documentElement,"return",false)){var l=f.Util.getElementChildrenNamedItem(n.documentElement,"data");for(var r=0;r<l.childNodes.length;r++){var o=l.childNodes.item(r);if(o.nodeType==1){var s=o;var u=new p;u.stepId=f.Util.getElementStringAttribute(s,"stepId");u.stepLabel=f.Util.getElementStringAttribute(s,"stepLabel");u.workFlowId=f.Util.getElementStringAttribute(s,"workFlowId");u.workFlowLabel=f.Util.getElementStringAttribute(s,"workFlowLabel");i.push(u)}}g.Progress.hide();m(i)}})};d.close=function(t,e,n,i,l){if(l===void 0){l=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(l);var r=f.Util.stringToXml("<workFlowEngine.close/>");r.documentElement.setAttribute("stepId",t.toString());r.documentElement.setAttribute("formId",e.toString());r.documentElement.setAttribute("formYear",n.toString());r.documentElement.setAttribute("formMonth",i.toString());d.httpClient.post(f.Util.xmlToString(r),c.ContentType.TextXML)};d.editHeartbeat=function(t,e,n,i,l){if(l===void 0){l=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(l);var r=f.Util.stringToXml("<workFlowEngine.editHeartbeat/>");r.documentElement.setAttribute("stepId",t.toString());r.documentElement.setAttribute("formId",e.toString());r.documentElement.setAttribute("formYear",n.toString());r.documentElement.setAttribute("formMonth",i.toString());d.httpClient.post(f.Util.xmlToString(r),c.ContentType.TextXML)};d.load=function(t,e,n,i,u,l,m){if(l===void 0){l=false}if(m===void 0){m=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(m);g.Progress.show("加载流程...",-1);var r=f.Util.stringToXml("<workFlowEngine.load/>");r.documentElement.setAttribute("stepId",t.toString());r.documentElement.setAttribute("formId",e.toString());r.documentElement.setAttribute("formYear",n.toString());r.documentElement.setAttribute("formMonth",i.toString());r.documentElement.setAttribute("isOpen",l?"true":"false");d.httpClient.post(f.Util.xmlToString(r),c.ContentType.TextXML,function(t){var e=null;var n=f.Util.stringToXml(t);if(f.Util.getElementBooleanAttribute(n.documentElement,"return",false)){e=new b;e.workFlowId=f.Util.getElementStringAttribute(n.documentElement,"workFlowId");e.workFlowLabel=f.Util.getElementStringAttribute(n.documentElement,"workFlowLabel");e.readOnly=f.Util.getElementBooleanAttribute(n.documentElement,"readOnly",false);e.editingUserLabel=f.Util.getElementStringAttribute(n.documentElement,"editingUserLabel","");var i=f.Util.getElementChildrenNamedItem(n.documentElement,"data");for(var l=0;l<i.childNodes.length;l++){var r=i.childNodes.item(l);if(r.nodeType==1){var o=r;if(o.localName=="item"){var s=new h;e.stepList.addItem(s);s.recordId=f.Util.getElementNumberAttribute(o,"id");s.context=f.Util.getElementStringAttribute(o,"context");s.createTime=f.Util.stringToDate(f.Util.getElementStringAttribute(o,"createTime"));s.formId=f.Util.getElementStringAttribute(o,"formId");s.formYear=f.Util.getElementNumberAttribute(o,"formYear");s.formMonth=f.Util.getElementNumberAttribute(o,"formMonth");s.formName=f.Util.getElementStringAttribute(o,"formName");s.goBackEnabled=f.Util.getElementBooleanAttribute(o,"goBackEnabled");s.state=f.Util.getElementNumberAttribute(o,"state",w.NONE);s.stepId=f.Util.getElementStringAttribute(o,"stepId");s.stepLabel=f.Util.getElementStringAttribute(o,"stepLabel");s.updateTime=f.Util.stringToDate(f.Util.getElementStringAttribute(o,"updateTime"));s.userId=f.Util.getElementStringAttribute(o,"userId");s.userLabel=f.Util.getElementStringAttribute(o,"userLabel");s.dataElement=f.Util.getElementChildrenNamedItem(o,"formData");s.users=f.Util.getElementStringAttribute(o,"users").split(",");s.port=m}}}}g.Progress.hide();if(u!=null){u(e)}})};d.create=function(t,s,e){if(e===void 0){e=null}if(d.httpClient==null)d.httpClient=new E.HttpClient(e);var n=new a.Dictionary;if(d.createWorkFlowDataFunction!=null){n=d.createWorkFlowDataFunction(t)}g.Progress.show("正在创建...",-1);var i=f.Util.stringToXml("<workFlowEngine.create><data/></workFlowEngine.create>");var l=f.Util.getElementChildrenNamedItem(i.documentElement,"data");for(var r=0;r<n.keys.length;r++){var o=n.keys[r];l.setAttribute(o,n.getValue(o))}i.documentElement.setAttribute("stepId",t.toString());d.httpClient.post(f.Util.xmlToString(i),c.ContentType.TextXML,function(t){var e=f.Util.stringToXml(t);var n=f.Util.getElementBooleanAttribute(e.documentElement,"return",false);var i=f.Util.getElementNumberAttribute(e.documentElement,"id",-1);var l=f.Util.getElementStringAttribute(e.documentElement,"formId","");var r=f.Util.getElementNumberAttribute(e.documentElement,"year",-1);var o=f.Util.getElementNumberAttribute(e.documentElement,"month",-1);s(n,i,l,r,o);g.Progress.hide()})};d.firstStepListCache=new a.Dictionary;d.stepList=null;return d}();e.WorkFlowEngine=i;var p=function(){function t(){this.stepId="";this.stepLabel="";this.workFlowId="";this.workFlowLabel="";this.number=0}return t}();e.WorkFlowStepDefinition=p;var b=function(){function t(){this.workFlowId="";this.workFlowLabel="";this.stepList=new n.ArrayCollection;this.readOnly=false;this.editingUserLabel=""}return t}();e.WorkFlowInfo=b;var h=function(){function t(){this.recordId=-1;this.formId="";this.userId="";this.stepLabel="";this.context="";this.userLabel="";this.state=w.NONE;this.stepId="";this.formName="";this.goBackEnabled=false;this.formMonth=-1;this.formYear=-1;this.port=null;this.visible=true}return t}();e.WorkFlowStepInfo=h;var w;(function(t){t[t["NONE"]=0]="NONE";t[t["SAVE"]=1]="SAVE";t[t["SUBMIT"]=9]="SUBMIT";t[t["GOBACK"]=-1]="GOBACK";t[t["COMPLETE"]=10]="COMPLETE"})(w=e.WorkFlowState||(e.WorkFlowState={}))});