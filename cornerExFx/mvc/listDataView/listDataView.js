var __extends=this&&this.__extends||function(){var i=function(t,e){i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var a in e)if(e.hasOwnProperty(a))t[a]=e[a]};return i(t,e)};return function(t,e){i(t,e);function a(){this.constructor=t}t.prototype=e===null?Object.create(e):(a.prototype=e.prototype,new a)}}();define(["require","exports","../../controls/listView/listView","../../core/util","../../communication/httpClient","../listDataBox/listDataBox","./whereBar","../../core/arrayCollection","../../mvvm/mvvmBase","./chartPanel","../../controls/handle/handle","../../core/fXEvent"],function(t,e,n,o,h,a,l,c,u,i,d,f){"use strict";Object.defineProperty(e,"__esModule",{value:true});var s=function(r){__extends(s,r);function s(t,e,a,i){if(e===void 0){e=null}if(a===void 0){a=false}if(i===void 0){i=false}var l=r.call(this,t,e,a)||this;l.listDataName="";l.date=new Date;l.isDark=false;l._mainTop=0;l.isChartInit=false;l.isSearchShowed=false;l.isChartShowed=false;l._toolBarVisible=true;l._pageBarVisible=true;l.fields=[];l.exportCSVFileName="导出数据";l.uri="data:application/vnd.ms-excel;base64,";l._pageCount=1;l._page=0;l.whereBarAC=new c.ArrayCollection;l.addEventListener(u.FxMVVMEvent.Load,function(t){l._xmlData=o.Util.getElementChildrenNamedItem(t.xml.documentElement,"data");if(l.chartsPanel!=null){l.chartsPanel.xmlDataProvider=l._xmlData}});if(!s.isCSSLoaded){Loader.loadCSS("cornerExFx/mvc/listDataView/skins/"+o.Util.skin+"/listDataView.css");s.isCSSLoaded=true}l.listDataName=t;l.isDark=a;l._control=new n.ListView(a,i);l.control.titleItems.addEventListener(f.FXCollectionEvent.Change,function(t){if(t.kind==f.CollectionEventKind.Add){t.items[t.location].addEventListener(f.FXMouseEvent.Click,function(t){var e=t.target;var a=l.control.titleItems.getItemIndex(e);for(var i=0;i<l.control.titleItems.count;i++){e=l.control.titleItems.getItemAt(i);if(i==a){var s=l.fields[i];l._info.orderField=s;if(s.type!=u.DatabaseDataType.Buffer&&s.type!=u.DatabaseDataType.Text){l._info.isDESC=!l._info.isDESC;if(l._info.isDESC){e.style=n.TitleStyle.OrderDESC}else{e.style=n.TitleStyle.Order}l.loadData()}else{e.style=n.TitleStyle.Default}}else{e.style=n.TitleStyle.Default}}})}else if(t.kind==f.CollectionEventKind.Remove){if(t.items.length>t.location&&t.location>=0){t.items[t.location].removeAllEventListener(f.FXMouseEvent.DoubleClick)}}else if(t.kind==f.CollectionEventKind.RemoveAll){for(var e=0;e<t.items.length;e++){t.items[e].removeAllEventListener(f.FXMouseEvent.DoubleClick)}}});l.httpClient=new h.HttpClient(e);l._control.percentWidth=100;l._control.percentHeight=100;l.loadHtml();l.listDataViewPageBarPageCount=o.Util.getElementByClass("listDataViewPageBarPageCount",l.element);l.listDataViewPageBar=o.Util.getElementByClass("listDataViewPageBar",l.element);l.listDataViewPageBarNext=o.Util.getElementById("listDataViewPageBarNext",l.element);l.listDataViewPageBarPrevious=o.Util.getElementById("listDataViewPageBarPrevious",l.element);l.listDataViewPageBarLast=o.Util.getElementById("listDataViewPageBarLast",l.element);l.listDataViewPageBarFirst=o.Util.getElementById("listDataViewPageBarFirst",l.element);l.listDataViewPageBarGo=o.Util.getElementById("listDataViewPageBarGo",l.element);l.listDataViewPageBarInfo=o.Util.getElementByClass("listDataViewPageBarInfo",l.element);l.listDataViewPageBarPageInput=o.Util.getElementByClass("listDataViewPageBarPageInput",l.element);l.listDataViewPageBarNext.onclick=function(){l.loadData(l._page+1)};l.listDataViewPageBarPrevious.onclick=function(){l.loadData(l._page-1)};l.listDataViewPageBarFirst.onclick=function(){l.loadData(0)};l.listDataViewPageBarLast.onclick=function(){l.loadData(l.pageCount-1)};l.listDataViewPageBarGo.onclick=function(){l.goPage()};l.listDataViewPageBarPageInput.onkeydown=function(t){if(t.keyCode==13){l.goPage()}};l.listDataViewMain=o.Util.getElementByClass("listDataViewMain",l.element);o.Util.appendDisplayObject(l.listDataViewMain,l._control);l.listDataViewExport.onclick=function(){l.exportCSV()};l.listDataViewRefresh.onclick=function(){l.loadData(l.page)};l.listDataViewSearchBar=o.Util.getElementByClass("listDataViewSearchBar",l.element);l.listDataViewSearch.onclick=function(){if(l.isSearchShowed){l.hideSearchBar()}else{l.showSearchBar()}};l.listDataViewChart.onclick=function(){if(l.isChartShowed){l.hideChart()}else{l.showChart()}};l.addEventListener(u.FxMVVMEvent.Load,function(t){if(l._info.chart!=null){if(l._info.chart.show){l.showChart()}}});return l}Object.defineProperty(s.prototype,"toolBarDiv",{get:function(){return this.listDataViewToolbar},enumerable:true,configurable:true});Object.defineProperty(s.prototype,"control",{get:function(){return this._control},enumerable:true,configurable:true});Object.defineProperty(s.prototype,"mainTop",{set:function(t){this._mainTop=t;this.setTop()},enumerable:true,configurable:true});s.prototype.showChart=function(){var s=this;if(!this.isChartInit){this.isChartInit=true;if(this._info.chart!=null){setTimeout(function(){var t=s.element.clientHeight*s._info.chart.percentHeight/100;s.showChartExec(t);s.setTop();s.listSelectFieldSetValue(s.chartsPanel.typeField,u.MVVMChartType[s._info.chart.type],false);s.listSelectFieldSetValue(s.chartsPanel.recordField,s._info.chart.recordField,true);s.listSelectFieldSetValue(s.chartsPanel.valueField,s._info.chart.valueField,true);if(s._info.chart.type==u.MVVMChartType.composite){if(s._info.chart.series!=null){for(var e=s.chartsPanel.seriesEditorAC.count;e<s._info.chart.series.length;e++){s.chartsPanel.addSeriesEditor()}for(var e=s._info.chart.series.length;e<s.chartsPanel.seriesEditorAC.count;e++){s.chartsPanel.removeSeriesEditor()}for(var e=0;e<s._info.chart.series.length;e++){var a=s._info.chart.series[e];var i=void 0;i=s.chartsPanel.seriesEditorAC.getItemAt(e);s.listSelectFieldSetValue(i.field,a.field,true);s.listSelectFieldSetValue(i.axisTypeField,a.axisType,false);s.listSelectFieldSetValue(i.typeField,a.type,false)}}}},1)}else{this.showChartExec()}}else{this.showChartExec()}};s.prototype.listSelectFieldSetValue=function(t,e,a){if(a===void 0){a=false}if(t!=null){for(var i=0;i<t.listBox.items.count;i++){var s=t.listBox.items.getItemAt(i);var l=s.data[0];if(a)l=l["name"];if(l==e){t.listBox.selectedItem=s;break}}}};s.prototype.showChartExec=function(t){var e=this;if(t===void 0){t=250}this.isChartShowed=true;this.listDataViewMain.className="listDataViewMain";this.listDataViewChart.className="toolButtonSelected";if(this.chartsPanel==null){this.chartsPanel=new i.ChartPanel(this._info);this.chartsPanel.height=t;this.chartsPanel.left=0;this.chartsPanel.right=40;this.chartsPanel.xmlDataProvider=this._xmlData;this._handle=new d.Handle;this._handle.left=0;this._handle.right=40;this._handle.height=5;this._handle.element.className="chartPanelHandle";this._handle.addEventListener(d.FXMoveEvent.MoveStart,function(t){e._handle.element.style.cursor="n-resize";e.isHandleMove=true;e.chartsHeight=e.chartsPanel.height});this._handle.addEventListener(d.FXMoveEvent.Move,function(t){e._handle.element.style.cursor="n-resize";e.isHandleMove=true;e.chartsPanel.height=e.chartsHeight+t.y;e.setTop()});this._handle.addEventListener(d.FXMoveEvent.MoveEnd,function(t){e.isHandleMove=false});this._handle.element.onmouseover=function(){e._handle.element.style.cursor="n-resize"};this._handle.element.onmouseout=function(){if(!e.isHandleMove){e._handle.element.style.cursor="default"}}}o.Util.appendDisplayObject(this.element,this.chartsPanel);o.Util.appendDisplayObject(this.element,this._handle);this.chartsPanel.visible=true;this._handle.visible=true;this.setTop()};s.prototype.hideChart=function(){this.isChartShowed=false;this.listDataViewChart.className="toolButton";this.setTop();this.chartsPanel.visible=false;this._handle.visible=false};s.prototype.setTop=function(){var t=this;var e=this._mainTop;if(this.isSearchShowed){this.listDataViewSearchBar.style.top=e+"px";e=e+40*this.whereBarAC.count}if(this.isChartShowed){this.chartsPanel.top=e;e=e+this.chartsPanel.height;this._handle.top=e;e+=5}this.listDataViewMain.style.top=e+"px";setTimeout(function(){t.listDataViewMain.className="listDataViewMainMove"},500)};s.prototype.showSearchBar=function(){this.isSearchShowed=true;this.listDataViewMain.className="listDataViewMain";this.listDataViewSearchBar.style.height=40*this.whereBarAC.count+"px";this.listDataViewSearchBar.style.visibility="visible";this.listDataViewSearchBar.style.display="inline";this.listDataViewSearch.className="toolButtonSelected";if(this.whereBarAC.count==0){this.addWhereBar()}this.setTop()};s.prototype.hideSearchBar=function(){this.listDataViewSearchBar.style.height="0px";this.listDataViewSearchBar.style.visibility="hidden";this.listDataViewSearchBar.style.display="none";this.listDataViewSearch.className="toolButton";this.isSearchShowed=false;this.searchWhere="";this.loadData(this.page);this.setTop()};s.prototype.delWhereBar=function(t){if(this.whereBarAC.count==1){this.hideSearchBar()}else{if(this.whereBarAC.contains(t)){this.whereBarAC.removeItem(t);t.addFunction=null;t.delFunction=null;t.searchFunction=null;o.Util.removeDislayObject(this.listDataViewSearchBar,t)}this.setSearchBar()}};s.prototype.addWhereBar=function(){var i=this;var t=new l.WhereBar(this._info,this.httpClient);this.whereBarAC.addItem(t);t.left=0;t.right=0;t.height=40;t.addFunction=function(t){i.addWhereBar()};t.delFunction=function(t){i.delWhereBar(t)};t.searchFunction=function(){i.searchWhere="";for(var t=0;t<i.whereBarAC.count;t++){var e=i.whereBarAC.getItemAt(t);var a=e.getWhere();if(o.Util.isNullStringValue(a)){i.searchWhere="";return}i.searchWhere+=e.getWhere()}i.loadData(i.page)};o.Util.appendDisplayObject(this.listDataViewSearchBar,t);this.setSearchBar()};s.prototype.setSearchBar=function(){for(var t=0;t<this.whereBarAC.count;t++){var e=this.whereBarAC.getItemAt(t);e.top=t*40;if(this.whereBarAC.count==1){e.location=l.WhereLocation.OnlyOne}else if(this.whereBarAC.count==t+1){e.location=l.WhereLocation.Last}else if(t==0){e.location=l.WhereLocation.First}else{e.location=l.WhereLocation.Middle}}this.listDataViewMain.style.top=40*this.whereBarAC.count+this._mainTop+"px";this.listDataViewSearchBar.style.height=40*this.whereBarAC.count+"px";this.setTop()};s.prototype.goPage=function(){var t=Number(this.listDataViewPageBarPageInput.value);if(isNaN(t)){t=1}if(t<1){t=1}if(t>this.pageCount){t=this.pageCount}this.listDataViewPageBarPageInput.value=String(t);this.loadData(t-1)};Object.defineProperty(s.prototype,"toolBarVisible",{get:function(){return this._toolBarVisible},set:function(t){this._toolBarVisible=t;if(this._toolBarVisible){this.listDataViewToolbar.style.visibility="visible";this.listDataViewToolbar.style.display="inline";this.listDataViewMain.style.right="40px";this.listDataViewPageBar.style.right="40px"}else{this.listDataViewToolbar.style.visibility="hidden";this.listDataViewToolbar.style.display="none";this.listDataViewPageBar.style.right="0px";this.listDataViewMain.style.right="0px"}},enumerable:true,configurable:true});Object.defineProperty(s.prototype,"pageBarVisible",{get:function(){return this._pageBarVisible},set:function(t){this._pageBarVisible=t;if(this._pageBarVisible){this.listDataViewPageBar.style.visibility="visible";this.listDataViewPageBar.style.display="inline";this.listDataViewMain.style.bottom="25px"}else{this.listDataViewPageBar.style.visibility="hidden";this.listDataViewPageBar.style.display="none";this.listDataViewMain.style.bottom="0px"}},enumerable:true,configurable:true});s.prototype.loadHtml=function(){this.element.innerHTML=Loader.loadTXT("cornerExFx/mvc/listDataView/skins/listDataView.html",true);this.listDataViewToolbar=o.Util.getElementByClass("listDataViewToolbar",this.element);this.loadToolbar()};s.prototype.loadToolbar=function(){this.listDataViewToolbar.innerHTML=Loader.loadTXT("cornerExFx/mvc/listDataView/skins/listDataViewTools.html",true);this.listDataViewExport=o.Util.getElementById("listDataViewExport",this.listDataViewToolbar);this.listDataViewRefresh=o.Util.getElementById("listDataViewRefresh",this.listDataViewToolbar);this.listDataViewSearch=o.Util.getElementById("listDataViewSearch",this.listDataViewToolbar);this.listDataViewChart=o.Util.getElementById("listDataViewChart",this.listDataViewToolbar)};s.prototype.loadData=function(t,e){if(t===void 0){t=0}if(e===void 0){e=null}this.date=new Date;r.prototype.loadData.call(this,t,e);this.listDataViewPageBarFirst.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarGo.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarLast.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarNext.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarPrevious.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarPageInput.className="listDataViewPageBarPageInputDisabled"};s.prototype.setControl=function(t){r.prototype.setControl.call(this,t);this.fields=[];if(this.control.titleItems.count==0){var e=t.labelField;this.control.titleItems.addItem(new n.TitleItem(e.label,e.cellWidth,this.isDark));this.fields.push(t.labelField);for(var a=0;a<t.dataFields.keys.length;a++){e=t.dataFields.getValue(t.dataFields.keys[a]);if(e.isView){this.control.titleItems.addItem(new n.TitleItem(e.label,e.cellWidth,this.isDark));this.fields.push(e)}}for(var a=0;a<this.fields.length;a++){var i=this.fields[a];var s=this.control.titleItems.getItemAt(a);if(this._info==null){s.style=n.TitleStyle.Default}else{if(this._info.orderField==i){if(this._info.isDESC){s.style=n.TitleStyle.OrderDESC}else{s.style=n.TitleStyle.Order}}else{s.style=n.TitleStyle.Default}}}}};s.prototype.exportCSV=function(){var t=this.exportCSVFileName;if(t==""||t==undefined||t==null){t=this.listDataName}if("msSaveBlob"in navigator){var e=new Blob(["\ufeff"+this.getCSV()],{type:"text/csv"});navigator.msSaveBlob(e,t+".csv")}else{if(this.exportCSVA==null){this.exportCSVA=document.createElement("a");this.exportCSVA.style.visibility="hidden";this.exportCSVA.style.display="none";document.body.appendChild(this.exportCSVA)}this.exportCSVA.download=t+".csv";this.exportCSVA.href="data:text/csv;charset=utf-8,\ufeff"+encodeURIComponent(this.getCSV());var a=document.createEvent("MouseEvents");a.initEvent("click",true,true);this.exportCSVA.dispatchEvent(a)}};s.prototype.getCSV=function(){var t="";for(var e=0;e<this.control.titleItems.count;e++){var a=this.control.titleItems.getItemAt(e);if(e>0)t+=",";t+=a.label}t+="\r\n";for(var e=0;e<this.control.items.count;e++){var i=this.control.items.getItemAt(e);t+=i.label;for(var s=0;s<this.control.titleItems.count-1;s++){var l="";t+=",";if(s<i.data.length){l=i.data[s];var r='"';if(l&&/[",\r\n]/g.test(l)){l=r+l.replace(/(")/g,'""')+r}}t+=l}t+="\r\n"}return t};s.prototype.setRowCount=function(t){this._rowCount=t;var e=Math.floor((this._rowCount-1)/this.pageRowCount)+1;if(e<0)e=1;this.setPageCount(e)};s.prototype.setPageCount=function(t){this._pageCount=t;if(this.listDataViewPageBarPageCount!=null){this.listDataViewPageBarPageCount.textContent="/"+this.pageCount.toString()+"页"}this.setPageOrPageCount()};Object.defineProperty(s.prototype,"pageCount",{get:function(){return this._pageCount},enumerable:true,configurable:true});s.prototype.setPage=function(t){if(t!=null){this._page=t;if(this.listDataViewPageBarPageInput!=null){this.listDataViewPageBarPageInput.value=(this._page+1).toString()}this.setPageOrPageCount()}};Object.defineProperty(s.prototype,"page",{get:function(){return this._page},enumerable:true,configurable:true});s.prototype.setPageOrPageCount=function(){if(this._pageCount==0){if(this._page!=0){this._page=0;this.loadData(this._page)}}else if(this._page+1>this._pageCount){this._page=this._pageCount-1;this.loadData(this._page)}if(this._page==0){this.listDataViewPageBarFirst.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarPrevious.className="listDataViewPageBarButtonDisabled"}else{this.listDataViewPageBarFirst.className="listDataViewPageBarButton";this.listDataViewPageBarPrevious.className="listDataViewPageBarButton"}if(this._page==this._pageCount-1||this.pageCount==0){this.listDataViewPageBarLast.className="listDataViewPageBarButtonDisabled";this.listDataViewPageBarNext.className="listDataViewPageBarButtonDisabled"}else{this.listDataViewPageBarLast.className="listDataViewPageBarButton";this.listDataViewPageBarNext.className="listDataViewPageBarButton"}this.listDataViewPageBarGo.className="listDataViewPageBarButton";this.listDataViewPageBarPageInput.className="listDataViewPageBarPageInput";var t=(new Date).getTime()-this.date.getTime();if(t!=0){this.listDataViewPageBarInfo.textContent=this._rowCount.toString()+"条记录，查询用时"+t/1e3+"秒"}};s.isCSSLoaded=false;return s}(a.ListDataBox);e.ListDataView=s});