var __extends=this&&this.__extends||function(){var i=function(t,e){i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var o in e)if(e.hasOwnProperty(o))t[o]=e[o]};return i(t,e)};return function(t,e){i(t,e);function o(){this.constructor=t}t.prototype=e===null?Object.create(e):(o.prototype=e.prototype,new o)}}();define(["require","exports","../../core/displayObject","../../core/util","../../communication/httpClient","../../communication/contentType","../../core/dictionary","../../mvvm/mvvmBase","../../controls/progress/progress","../../controls/messageBox/messageBox","../../controls/listBox/listBox"],function(t,e,o,s,a,l,u,c,d,h,f){"use strict";Object.defineProperty(e,"__esModule",{value:true});var i=function(r){__extends(t,r);function t(t,e,o,i){if(e===void 0){e=null}if(o===void 0){o=false}if(i===void 0){i=true}var n=r.call(this)||this;n.pageRowCount=100;n.searchWhere="";n.listDataName="";n.isDark=false;n.showProgress=true;n.where="";n._info=null;n.additionalData=new u.Dictionary;n._rowCount=1;n._page=0;n.showProgress=i;n.listDataName=t;n.isDark=o;n._control=new f.ListBox(o);n.httpClient=new a.HttpClient(e);n._control.percentWidth=100;n._control.percentHeight=100;n.loadHtml();s.Util.appendDisplayObject(n.element,n._control);return n}Object.defineProperty(t.prototype,"control",{get:function(){return this._control},enumerable:true,configurable:true});t.prototype.loadHtml=function(){};Object.defineProperty(t.prototype,"Info",{get:function(){return this._info},enumerable:true,configurable:true});t.prototype.load=function(e){var o=this;if(e===void 0){e=""}c.MVVMInfo.loadListInfo(this.listDataName,this.httpClient,function(t){o._info=t;o.loadFromInfo(t,e)})};t.prototype.loadFromInfo=function(t,e){if(e===void 0){e=""}this._info=t;this.where=e;if(this.loadInfoFunction!=null){t=this.loadInfoFunction(t)}this.setControl(t);this.loadData(this.page,e)};t.prototype.setControl=function(t){this.control.dataFields=[];for(var e=0;e<t.dataFields.keys.length;e++){var o=t.dataFields.getValue(t.dataFields.keys[e]);if(o.isView){this.control.dataFields.push(o.name)}}for(var e=0;e<t.dataFields.keys.length;e++){var o=t.dataFields.getValue(t.dataFields.keys[e]);if(!o.isView){this.control.dataFields.push(o.name)}}if(t.labelField!=null)this.control.labelField=t.labelField.name;if(t.iconField!=null)this.control.iconField=t.iconField.name;if(t.idField!=null)this.control.idField=t.idField.name};t.prototype.setRowCount=function(t){this._rowCount=t};Object.defineProperty(t.prototype,"rowCount",{get:function(){return this._rowCount},enumerable:true,configurable:true});t.prototype._loadDataXMLFunction=function(t){};t.prototype.loadData=function(t,e){var n=this;if(t===void 0){t=null}if(e===void 0){e=null}if(e!=null){this.where=e}if(t<0)t=0;this.setPage(t);if(this.showProgress)d.Progress.show("正在加载...",-1);var o=s.Util.stringToXml("<loadList/>");o.documentElement.setAttribute("name",this.listDataName);o.documentElement.setAttribute("where",this.where+(this.searchWhere!=""&&this.where!=""?" AND ":"")+(this.searchWhere!=""?"(":"")+this.searchWhere+(this.searchWhere!=""?")":""));o.documentElement.setAttribute("pageRowCount",this.pageRowCount.toString());o.documentElement.setAttribute("page",this._page.toString());if(this._info!=null){if(this._info.orderField!=null){o.documentElement.setAttribute("orderField",this._info.orderField.name);o.documentElement.setAttribute("isDESC",this._info.isDESC?"true":"false")}}for(var i=0;i<this.additionalData.keys.length;i++){var r=this.additionalData.keys[i];o.documentElement.setAttribute(r,this.additionalData.getValue(r))}this._loadDataXMLFunction(o);this.httpClient.post(s.Util.xmlToString(o),l.ContentType.TextXML,function(t){var e=s.Util.stringToXml(t);if(s.Util.getElementBooleanAttribute(e.documentElement,"return",false)){n.setRowCount(s.Util.getElementNumberAttribute(e.documentElement,"rowCount",0));var o=s.Util.getElementChildrenNamedItem(e.documentElement,"data");if(n.loadDataFunction!=null){o=n.loadDataFunction(o)}n.control.xmlDataProvider=o;if(n.showProgress)d.Progress.hide();var i=new c.FxMVVMEvent;i.type=c.FxMVVMEvent.Load;i.xml=e;i.target=n;i.items=n.control.items;n.dispatchEvent(i);n.control.refresh()}else{if(n.showProgress)d.Progress.hide();h.MessageBox.show("加载数据失败！","加载数据",h.MessageBoxButtons.OK,h.MessageBoxIcon.Error)}})};t.prototype.setPage=function(t){if(t!=null){this._page=t}};Object.defineProperty(t.prototype,"page",{get:function(){return this._page},enumerable:true,configurable:true});return t}(o.DisplayObject);e.ListDataBox=i});