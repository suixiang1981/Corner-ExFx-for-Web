var __extends=this&&this.__extends||function(){var l=function(e,i){l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var t in i)if(i.hasOwnProperty(t))e[t]=i[t]};return l(e,i)};return function(e,i){l(e,i);function t(){this.constructor=e}e.prototype=i===null?Object.create(i):(t.prototype=i.prototype,new t)}}();define(["require","exports","./fieldBase","../../core/util","../../communication/httpClient","../../communication/contentType","../../communication/httpUtil","../../communication/dataType","../messageBox/messageBox","../../core/fXEvent"],function(e,i,t,s,o,r,n,a,u,l){"use strict";Object.defineProperty(i,"__esModule",{value:true});var p=function(i){__extends(t,i);function t(){var e=i.call(this)||this;e._showClear=false;e.postHost="";e.postPort=null;e._enabled=true;e.maxSize=10485760;if(!t.isFileFieldCSSLoaded){t.isFileFieldCSSLoaded=true;Loader.loadCSS("cornerExFx/controls/fields/skins/"+s.Util.skin+"/fileField.css")}e.value=e._value;return e}Object.defineProperty(t.prototype,"labelWidth",{set:function(e){this._labelWidth=e;this.inputDiv.style.left=e+5+"px";this.fieldIcon.style.left=e+8+"px";this.labelDiv.style.width=e+"px"},enumerable:true,configurable:true});t.prototype.loadHTML=function(){var a=this;this.element.innerHTML=Loader.loadTXT("cornerExFx/controls/fields/skins/"+s.Util.skin+"/fileField.html",true);this.fieldIcon=s.Util.getElementByClass("fieldIcon",this.element);this.fieldBrowseDiv=s.Util.getElementByClass("fieldBrowseDiv",this.element);this.fieldClearDiv=s.Util.getElementByClass("fieldClearDiv",this.element);this.fieldBrowseDiv.onclick=function(){a.input.click();a.input.onchange=function(e){var l=e.target["files"][0];if(l==null||l==undefined){return}var i=new FormData;i.append(a.field,l);if(l.size>a.maxSize){var t=void 0;if(a.maxSize<1024*1024){t=Math.ceil(a.maxSize/1024)+"KB"}else{t=Math.ceil(a.maxSize/1024/1024)+"MB"}u.MessageBox.show("上传的文件过大，请选择小于"+t+"的文件。","上传",u.MessageBoxButtons.OK,u.MessageBoxIcon.Error);return}var s=new f;s.target=a;s.type=f.Uploading;s.fileName=l.name;s.path="";s.size=l.size;a.dispatchEvent(s);if(!s.cancel){var n=new o.HttpClient(a.postPort,a.postHost);n.post(i,r.ContentType.MultipartFormData,function(e){if(a.uploadFunction!=null){a.value=a.uploadFunction(e)}else{if(e=="[ERROR]"){var i=new f;i.target=a;i.type=f.Error;i.fileName=l.name;i.path="";i.size=l.size;a.dispatchEvent(i);if(!i.cancel){u.MessageBox.show("上传文件时发生错误！","上传",u.MessageBoxButtons.OK,u.MessageBoxIcon.Error)}}else{a.value=e;var t=new f;t.target=a;t.type=f.Upload;t.fileName=l.name;t.path=e;t.size=l.size;a.dispatchEvent(t)}}},function(e,i){a.inputDiv.innerHTML="正在上传("+Math.ceil(100*e/i).toString()+"%)..."},function(){});a.inputDiv.innerHTML="正在上传..."}}};this.fieldClearDiv.onclick=function(){if(s.Util.isNullStringValue(a._value)){a.value="";var e=new f;e.target=a;e.type=f.Upload;e.fileName="";e.path="";e.size=0;a.dispatchEvent(e)}else{u.MessageBox.show("是否删除当前项？","删除",u.MessageBoxButtons.YesNo,u.MessageBoxIcon.Information,function(e){if(e==u.MessageBoxButton.Yes){a.value="";var i=new f;i.target=a;i.type=f.Upload;i.fileName="";i.path="";i.size=0;a.dispatchEvent(i)}})}}};t.prototype.valueStringToValue=function(){this.value=this.valueString};t.prototype.valueToValueString=function(){this.valueString=this.value};t.prototype.setInputValue=function(){var i=this;this.valueToValueString();var e="file";if(s.Util.isNullStringValue(this._value)){this.inputDiv.innerHTML="[空]";this.input.value="";if(this._showClear){this.fieldClearDiv.style.visibility="visible"}else{this.fieldClearDiv.style.visibility="hidden"}}else{var t=n.HttpUtil.extensionToDataType(s.Util.getExtension(this._value));if(t==a.DataType.BMP||t==a.DataType.IMAGE||t==a.DataType.TGA){e="picture"}else if(t==a.DataType.CSV||t==a.DataType.XLS||t==a.DataType.XLSX){e="excel"}else if(t==a.DataType.DOC||t==a.DataType.RTF||t==a.DataType.DOCX){e="word"}else if(t==a.DataType.PPT||t==a.DataType.PPTX){e="powerpoint"}else if(t==a.DataType.PDF){e="pdf"}else if(t==a.DataType.ZIP){e="zip"}else if(t==a.DataType.TEXT){e="txt"}this.inputDiv.innerHTML="<a target='_blank' href='"+this._value+"'>"+s.Util.getFileName(this._value)+"</a>";var l=this.anchor;l.onclick=function(){var e=new f;e.target=i;e.type=f.Download;e.fileName=s.Util.getFileName(i._value);e.path=i._value;i.dispatchEvent(e);return!e.cancel};if(this._enabled){this.fieldClearDiv.style.visibility="visible"}else{this.fieldClearDiv.style.visibility="hidden"}}this.fieldIcon.src="cornerExFx/controls/fields/skins/"+s.Util.skin+"/"+e+".png"};Object.defineProperty(t.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e;if(this._enabled){this.fieldBrowseDiv.style.visibility="visible";if(s.Util.isNullStringValue(this._value)){if(this._showClear){this.fieldClearDiv.style.visibility="visible"}else{this.fieldClearDiv.style.visibility="hidden"}}else{this.fieldClearDiv.style.visibility="visible"}this.input["disabled"]=false;this.input.style.color="#000000";this.labelDiv.style.color="#000000"}else{this.input["disabled"]=true;this.input.style.color="#666666";this.labelDiv.style.color="#666666";this.fieldBrowseDiv.style.visibility="hidden";this.fieldClearDiv.style.visibility="hidden"}},enumerable:true,configurable:true});t.isFileFieldCSSLoaded=false;return t}(t.FieldBase);i.FileField=p;var f=function(e){__extends(i,e);function i(){return e!==null&&e.apply(this,arguments)||this}i.Uploading="uploading";i.Upload="upload";i.Error="error";i.Download="download";return i}(l.FXEvent);i.FxFileFieldEvent=f});