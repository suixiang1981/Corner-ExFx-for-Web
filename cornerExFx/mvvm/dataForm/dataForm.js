var __extends=this&&this.__extends||function(){var l=function(e,t){l=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i]};return l(e,t)};return function(e,t){l(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}();define(["require","exports","../../controls/form/form","../../mvvm/mvvmBase","../../communication/httpClient","../../core/util","../../controls/fields/listSelectField","../../controls/fields/stringField","../../controls/fields/numberField","../../controls/listBox/listBox","../../controls/listBox/listBase","../../communication/contentType","../../controls/progress/progress","../../controls/messageBox/messageBox","../../controls/fields/textField","../../controls/fields/passwordField","../../controls/fields/FileField","../../controls/fields/filesField","../../core/fXEvent","../../controls/fields/dateField","../../controls/fields/stringBrowseField","../../communication/httpUtil","../../communication/dataType","./dataFormPreview","../../controls/fields/phoneField"],function(e,t,l,d,s,m,r,u,f,h,c,F,o,g,p,v,x,y,M,E,b,T,L,w,B){"use strict";Object.defineProperty(t,"__esModule",{value:true});var i=function(a){__extends(e,a);function e(e,t,i,l,n){if(t===void 0){t=true}if(i===void 0){i=null}if(l===void 0){l=false}if(n===void 0){n=true}var o=a.call(this,l)||this;o.showProgress=true;o.year=-1;o.month=-1;o.info=null;o.loadFieldI=0;o._enabled=true;o.showProgress=n;o.isListMode=l;o._listDataName=e;o.httpClient=new s.HttpClient(i);o.isEditMode=t;return o}Object.defineProperty(e.prototype,"listDataName",{get:function(){return this._listDataName},enumerable:true,configurable:true});e.prototype.load=function(e,t,i){var l=this;if(e===void 0){e=""}if(t===void 0){t=-1}if(i===void 0){i=-1}this.year=t;this.month=i;this.id=e;d.MVVMInfo.loadListInfo(this._listDataName,this.httpClient,function(e){l.info=e;l.loadFieldControls()})};e.prototype.loadFromMVVMListInfo=function(e){this.info=e;this.loadFieldControls()};e.prototype.loadData=function(){var n=this;if(this.dataFunction!=null){var e=this.dataFunction(this.id);this.xmlDataProvider=e;this.enabled=this._enabled;this.refresh();var t=new d.FxMVVMEvent;t.type=d.FxMVVMEvent.Load;t.target=this;t.items.removeAll();t.items.addItem(this);this.dispatchEvent(t)}else{if(m.Util.isNullStringValue(this.id)){this.xmlDataProvider=m.Util.stringToXml("<data/>").documentElement;setTimeout(function(){n.refresh();var e=new d.FxMVVMEvent;e.type=d.FxMVVMEvent.Load;e.target=n;e.items.removeAll();e.items.addItem(n);n.dispatchEvent(e)},1)}else{if(this.showProgress)o.Progress.show("正在加载...",-1);var i=m.Util.stringToXml("<loadListItem/>");i.documentElement.setAttribute("name",this._listDataName);i.documentElement.setAttribute(this.info.idField.name,this.id);this.httpClient.post(m.Util.xmlToString(i),F.ContentType.TextXML,function(e){var t=m.Util.stringToXml(e);if(m.Util.getElementBooleanAttribute(t.documentElement,"return",false)){var i=m.Util.getElementChildrenNamedItem(t.documentElement,"data");n.xmlDataProvider=i.childNodes.item(0);if(n.showProgress)o.Progress.hide();n.refresh();var l=new d.FxMVVMEvent;l.type=d.FxMVVMEvent.Load;l.target=n;l.items.removeAll();l.items.addItem(n);l.xml=t;n.dispatchEvent(l)}else{if(n.showProgress)o.Progress.hide();g.MessageBox.show("加载数据失败！","加载数据",g.MessageBoxButtons.OK,g.MessageBoxIcon.Error)}n.enabled=n._enabled;n.refresh()})}}};e.prototype.loadFieldControls=function(){for(var e=0;e<this.fields.count;e++){var t=this.fields.getItemAt(e);m.Util.removeDislayObject(this.element,t)}this.fields.removeAll();var i=[];var l=this.info.labelField;if(l!=null){if(l.isAdd&&!this.isEditMode||l.isEdit&&this.isEditMode){i.push(l)}}l=this.info.iconField;if(l!=null){if(l.isAdd&&!this.isEditMode||l.isEdit&&this.isEditMode){i.push(l)}}for(var e=0;e<this.info.dataFields.keys.length;e++){l=this.info.dataFields.getValue(this.info.dataFields.keys[e]);if(l.isAdd&&!this.isEditMode||l.isEdit&&this.isEditMode){i.push(l)}}this.loadFieldI=0;this.loadFieldControlsFromMVVMFieldList(i)};e.prototype.setField=function(e,t){if(e!=null){e.label=t.label;e.enabled=t.enabled;e.labelWidth=t.controlLabelWidth;if(this.isListMode){e.percentWidth=100}else{e.width=t.controlWidth}e.height=t.controlHeight;if(!m.Util.isNullNumberValue(t.controlPercentWidth)){e.percentWidth=t.controlPercentWidth}if(!m.Util.isNullNumberValue(t.controlPercentHeight)){e.percentHeight=t.controlPercentHeight}if(e.tag==null){e.tag=new Object}e.tag=new Object;if(this.isListMode){e.tag.controlIsNewLine=true}else{e.tag.controlIsNewLine=t.controlIsNewLine}}};e.prototype.loadFieldControlsFromMVVMFieldList=function(t){var n=this;if(this.loadFieldI<t.length){var o=t[this.loadFieldI];var a;if(!m.Util.isNullStringValue(o.label)){if(!m.Util.isNullStringValue(o.list)){a=new r.ListSelectField;a.field=o.name;a.minLenght=o.minLenght;this.fields.addItem(a);this.loadListSelectFieldInfo(o,a,function(){a.loadItemFunciont=function(e,t){var i="";var l=t;if(n.listSelectFieldWhereFunction!=null){i=n.listSelectFieldWhereFunction(a.field)}n.loadListSelectFieldValue(e,o,a,i,function(e){l(e)})};a.loadItemsByXmlDataProviderFunciont=function(e){n.loadListSelectFieldData(a,o)};a.xmlDataProvider=n._dataElement})}else if(!m.Util.isNullStringValue(o.tree)){}else if(o.controlType==d.MVVMControlType.Other){Loader.loadModule(o.controlPath,function(){var e=Loader.getModuleClass(o.controlPath,o.controlClass);a=new e;a.field=o.name;a.xmlDataProvider=n._dataElement;n.fields.addItem(a);n.setField(a,o);n.loadFieldI++;n.loadFieldControlsFromMVVMFieldList(t)});return}else if(o.type==d.DatabaseDataType.Date){a=new E.DateField(o.dateDataType==m.DateDataType.DateTime||o.dateDataType==m.DateDataType.DateTimeHM);a.field=o.name;a.xmlDataProvider=this._dataElement;this.fields.addItem(a)}else if(o.type==d.DatabaseDataType.String||o.type==d.DatabaseDataType.Text){if(o.controlType==d.MVVMControlType.String){a=new u.StringField;a.field=o.name;a.maxLenght=o.maxLenght;a.minLenght=o.minLenght}else if(o.controlType==d.MVVMControlType.Phone){a=new B.PhoneField;a.field=o.name;a.maxLenght=o.maxLenght;a.minLenght=o.minLenght;a.showCallButton=o.showCallButton;a.callFunction=function(e){if(n.callFunction!=null){n.callFunction(e,a.field)}}}else if(o.controlType==d.MVVMControlType.Browse){a=new b.StringBrowseField;a.field=o.name;a.inputEnabled=o.inputEnabled;a.dialogHeight=o.dialogHeight;a.dialogWidth=o.dialogWidth;a.minLenght=o.minLenght;a.openFunction=function(e,t){if(n.browseFieldOpenFunction!=null)n.browseFieldOpenFunction(e,t)};a.selectedFunction=function(e){if(n.browseFieldSelectedFunction!=null){return n.browseFieldSelectedFunction(e)}else{return null}}}else if(o.controlType==d.MVVMControlType.Text||o.controlType==d.MVVMControlType.MultilineText){a=new p.TextField;a.field=o.name;a.maxLenght=o.maxLenght;a.minLenght=o.minLenght;if(o.controlType==d.MVVMControlType.MultilineText){a.multiLine=true}else{a.multiLine=false}}else if(o.controlType==d.MVVMControlType.Password){a=new v.PasswordField;a.field=o.name;a.maxLenght=o.maxLenght;a.minLenght=o.minLenght}else if(o.controlType==d.MVVMControlType.File||o.controlType==d.MVVMControlType.Files){if(o.controlType==d.MVVMControlType.File){a=new x.FileField}else{a=new y.FilesField;var e=a.fileFieldCollection;e.addEventListener(M.FXCollectionEvent.Change,function(e){setTimeout(function(){n.refresh();if(n.dataFormPreview!=null){n.dataFormPreview.close()}},1)})}a["addEventListener"](x.FxFileFieldEvent.Download,function(e){var t=T.HttpUtil.extensionToDataType(m.Util.getExtension(e.fileName));if(t==L.DataType.BMP||t==L.DataType.IMAGE||t==L.DataType.TGA){e.cancel=true;if(n.dataFormPreview==null){n.dataFormPreview=new w.DataFormPreview;m.Util.appendDisplayObject(n.element,n.dataFormPreview)}n.dataFormPreview.percentWidth=100;n.dataFormPreview.setField(e);n.dataFormPreview.refresh=function(){n.refresh()};var i=new l.FxFormEvent;i.target=n;i.type=l.FxFormEvent.Resize;n.dispatchEvent(i)}});a.field=o.name;a["removeAllEventListener"](x.FxFileFieldEvent.Upload);a["addEventListener"](x.FxFileFieldEvent.Upload,function(i){var e;if(n.isEditMode){e=m.Util.stringToXml("<editListItem><data/></editListItem>")}var t=m.Util.getElementChildrenNamedItem(e.documentElement,"data");e.documentElement.setAttribute(n.info.idField.name,n.id);e.documentElement.setAttribute("name",n._listDataName);e.documentElement.setAttribute("year",n.year.toString());e.documentElement.setAttribute("month",n.month.toString());t.setAttribute(a.field,a.value);n.httpClient.post(m.Util.xmlToString(e),F.ContentType.TextXML,function(e){var t=m.Util.stringToXml(e);if(!m.Util.getElementBooleanAttribute(t.documentElement,"return",false)){g.MessageBox.show("文件上传后下载路径存储失败","上传",g.MessageBoxButtons.OK,g.MessageBoxIcon.Error)}else{if(i.path==null||i.path==""){}else{g.MessageBox.show("文件上传成功!","上传",g.MessageBoxButtons.OK,g.MessageBoxIcon.Information)}}})})}a.xmlDataProvider=this._dataElement;this.fields.addItem(a)}else if(o.type==d.DatabaseDataType.Number){a=new f.NumberField;a.field=o.name;a.maxValue=o.maxValue;a.minValue=o.minValue;a.decimals=o.decimals;a.stepSize=1/Math.pow(10,o.decimals);a.xmlDataProvider=this._dataElement;this.fields.addItem(a)}else if(o.type==d.DatabaseDataType.Boolean){a=new r.ListSelectField;a.field=o.name;var i=a;i.listBox.dataFields=[o.name];i.listBox.labelField="label";i.listBox.idField=o.name;i.listBox.items.addItem(new h.ListBoxItem("是","",["true"]));i.listBox.items.addItem(new h.ListBoxItem("否","",["false"]));i.popup();i.loadItemFunciont=function(e,t){if(e=="true"||e=="1"){t(new c.ListItemData("是","",["true"]));i.listBox.selectedItem=i.listBox.items.getItemAt(0)}else{i.listBox.selectedItem=i.listBox.items.getItemAt(1);t(new c.ListItemData("否","",["false"]))}};a.xmlDataProvider=this._dataElement;this.fields.addItem(a)}this.setField(a,o);this.loadFieldI++;this.loadFieldControlsFromMVVMFieldList(t)}else{this.loadFieldI++;this.loadFieldControlsFromMVVMFieldList(t)}}else{this.loadData();this.loadFieldI=0}};e.prototype.loadListSelectFieldData=function(s,e){var t=m.Util.stringToXml("<loadList/>");t.documentElement.setAttribute("name",e.list);if(this.listSelectFieldWhereFunction!=null){t.documentElement.setAttribute("where",this.listSelectFieldWhereFunction(s.field))}this.httpClient.post(m.Util.xmlToString(t),F.ContentType.TextXML,function(e){var t=m.Util.stringToXml(e);if(m.Util.getElementBooleanAttribute(t.documentElement,"return",false)){var i=m.Util.getElementChildrenNamedItem(t.documentElement,"data");s.listBox.xmlDataProvider=i;s.popup();if(s.value!=null){var l=s.listBox.getIdByData(s.value);for(var n=0;n<s.listBox.items.count;n++){var o=s.listBox.items.getItemAt(n);var a=s.listBox.getIdByData(o);if(l==a){s.listBox.selectedItem=o;return}}}}})};e.prototype.loadListSelectFieldInfo=function(e,t,i){d.MVVMInfo.loadListInfo(e.list,this.httpClient,function(e){if(e.idField!=null){t.listBox.idField=e.idField.name;if(t.tag==null)t.tag=new Object;t.tag.type=e.idField.type}if(e.labelField!=null)t.listBox.labelField=e.labelField.name;if(e.idField!=null)t.listBox.dataFields=[e.idField.name];if(e.iconField!=null)t.listBox.iconField=e.iconField.name;i()})};e.prototype.loadListSelectFieldValue=function(e,t,s,i,r){s.value=new c.ListItemData("","",[]);var l=m.Util.stringToXml("<loadList/>");l.documentElement.setAttribute("name",t.list);var n;if(m.Util.isNullStringValue(e)){n=""}else{var o=s.tag.type==d.DatabaseDataType.String||s.tag.type==d.DatabaseDataType.Text||s.tag.type==d.DatabaseDataType.Date?"'":"";n=s.listBox.idField+"="+o+e+o+(m.Util.isNullStringValue(i)?"":" and ("+i+")")}l.documentElement.setAttribute("where",n);this.httpClient.post(m.Util.xmlToString(l),F.ContentType.TextXML,function(e){var t=m.Util.stringToXml(e);if(m.Util.getElementBooleanAttribute(t.documentElement,"return",false)){var i=m.Util.getElementChildrenNamedItem(m.Util.getElementChildrenNamedItem(t.documentElement,"data"),"item");var l=[];for(var n=0;n<s.listBox.dataFields.length;n++){var o=s.listBox.dataFields[n];l.push(m.Util.getElementStringAttribute(i,o,""))}var a=new c.ListItemData(m.Util.getElementStringAttribute(i,s.listBox.labelField,""),m.Util.getElementStringAttribute(i,s.listBox.iconField,""),l);r(a)}})};e.prototype.getXMLStr=function(){var e;if(this.isEditMode){e=m.Util.stringToXml("<editListItem><data/></editListItem>")}else{e=m.Util.stringToXml("<addListItem><data/></addListItem>")}var t=m.Util.getElementChildrenNamedItem(e.documentElement,"data");e.documentElement.setAttribute(this.info.idField.name,this.id);e.documentElement.setAttribute("name",this._listDataName);e.documentElement.setAttribute("year",this.year.toString());e.documentElement.setAttribute("month",this.month.toString());for(var i=0;i<this.xmlDataProvider.attributes.length;i++){var l=this.xmlDataProvider.attributes.item(i);t.setAttribute(l.name,l.value)}return m.Util.xmlToString(e)};e.prototype.save=function(e){var i=this;if(e===void 0){e=null}var l=e;this.verify();if(!this.verified){g.MessageBox.show("请完善所填写的信息。","无法保存",g.MessageBoxButtons.OK,g.MessageBoxIcon.Error);return}if(this.showProgress)o.Progress.show("正在保存...",-1);var t=this.getXMLStr();this.httpClient.post(t,F.ContentType.TextXML,function(e){var t=m.Util.stringToXml(e);if(m.Util.getElementBooleanAttribute(t.documentElement,"return",false)){if(i.showProgress)o.Progress.hide();if(l!=null){l()}}else{if(i.showProgress)o.Progress.hide();g.MessageBox.show("保存数据失败","保存",g.MessageBoxButtons.OK,g.MessageBoxIcon.Error)}})};Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled},set:function(e){this._enabled=e;for(var t=0;t<this.fields.count;t++){var i=this.fields.getItemAt(t);if(e){var l=void 0;if(this.info.idField!=null){if(i.field==this.info.idField.name){l=this.info.idField}}if(l==null){l=this.info.dataFields.getValue(i.field)}if(l!=null){i.enabled=l.enabled}else{i.enabled=true}}else{i.enabled=false}}},enumerable:true,configurable:true});return e}(l.Form);t.DataForm=i});