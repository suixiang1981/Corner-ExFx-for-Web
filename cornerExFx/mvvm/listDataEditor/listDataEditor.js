var __extends=this&&this.__extends||function(){var o=function(t,e){o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)if(e.hasOwnProperty(i))t[i]=e[i]};return o(t,e)};return function(t,e){o(t,e);function i(){this.constructor=t}t.prototype=e===null?Object.create(e):(i.prototype=e.prototype,new i)}}();define(["require","exports","../../core/util","../../mvc/listDataView/listDataView","./listDataEditorDialog","../../controls/messageBox/messageBox","../../controls/progress/progress","../../communication/contentType","../../core/fXEvent","../mvvmBase","../../core/dictionary"],function(t,e,l,i,o,n,s,r,d,c,u){"use strict";Object.defineProperty(e,"__esModule",{value:true});var a=function(a){__extends(t,a);function t(t,e,i){if(e===void 0){e=null}if(i===void 0){i=false}var o=a.call(this,t,e,false,i)||this;o._additionalData=new u.Dictionary;o.port=e;o.listDataEditorAdd.onclick=function(){o.add()};o.listDataEditorDel.onclick=function(){o.del()};o.listDataEditorEdit.onclick=function(){o.edit()};o.control.addEventListener(d.FXListEvent.Change,function(t){if(t.newItem!=null){o.listDataEditorEdit.className="toolButton";o.listDataEditorDel.className="toolButton"}else{o.listDataEditorEdit.className="toolButtonDisabled";o.listDataEditorDel.className="toolButtonDisabled"}});return o}t.prototype.loadData=function(t,e){if(t===void 0){t=0}if(e===void 0){e=null}a.prototype.loadData.call(this,t,e);this.listDataEditorEdit.className="toolButtonDisabled";this.listDataEditorDel.className="toolButtonDisabled"};t.prototype.loadToolbar=function(){this.listDataViewToolbar.innerHTML=Loader.loadTXT("cornerExFx/mvvm/listDataEditor/skins/listDataEditorTools.html",true);this.listDataViewExport=l.Util.getElementById("listDataViewExport",this.listDataViewToolbar);this.listDataViewRefresh=l.Util.getElementById("listDataViewRefresh",this.listDataViewToolbar);this.listDataViewSearch=l.Util.getElementById("listDataViewSearch",this.listDataViewToolbar);this.listDataEditorAdd=l.Util.getElementById("listDataEditorAdd",this.listDataViewToolbar);this.listDataEditorDel=l.Util.getElementById("listDataEditorDel",this.listDataViewToolbar);this.listDataEditorEdit=l.Util.getElementById("listDataEditorEdit",this.listDataViewToolbar);this.listDataViewChart=l.Util.getElementById("listDataViewChart",this.listDataViewToolbar)};t.prototype.edit=function(){var e=this;if(this.control.selectedItem!=null){if(this.editDialog==null){this.editDialog=new o.ListDataEditorDialog(this.listDataName,true,this.port);this.editDialog.width=400;this.editDialog.editCallback=function(t){e.editFunction(t)};this.editDialog.listSelectFieldWhereFunction=function(t){return e.listSelectFieldWhere(t)}}if(this.dataFormFunction!=null){this.dataFormFunction(this.editDialog.dataForm)}setTimeout(function(){l.Util.appendDisplayObject(document.body,e.editDialog);e.editDialog.showDialog(true,e.control)},1)}};t.prototype.del=function(){var a=this;if(this.control.selectedItem!=null){n.MessageBox.show("是否删除当前选中的项？<br/>注意：该操作不可撤销。","删除",n.MessageBoxButtons.YesNo,n.MessageBoxIcon.Warning,function(t){if(t==n.MessageBoxButton.Yes){s.Progress.show("正在删除...",-1);var e=l.Util.stringToXml("<deleteListItem/>");e.documentElement.setAttribute("name",a.listDataName);e.documentElement.setAttribute(a.control.idField,a.control.getIdByItem(a.control.selectedItem));a.httpClient.post(l.Util.xmlToString(e),r.ContentType.TextXML,function(t){var e=l.Util.stringToXml(t);if(l.Util.getElementBooleanAttribute(e.documentElement,"return",false)){var i=new c.FxMVVMEvent;i.item=a.control.selectedItem;var o=a.control.items.getItemIndex(a.control.selectedItem);a.control.items.removeItem(a.control.selectedItem);if(o<a.control.items.count-1){a.control.selectedItem=a.control.items.getItemAt(o)}else if(o>0){a.control.selectedItem=a.control.items.getItemAt(o-1)}i.type=c.FxMVVMEvent.Deleted;i.target=a;i.items=a.control.items;i.xml=t.ownerDocument;a.dispatchEvent(i)}else{n.MessageBox.show("无法删除选中的项","删除",n.MessageBoxButtons.OK,n.MessageBoxIcon.Error)}s.Progress.hide()})}},300,160)}};t.prototype.add=function(){var e=this;if(this.addDialog==null){this.addDialog=new o.ListDataEditorDialog(this.listDataName,false,this.port);this.addDialog.width=400;this.addDialog.addCallback=function(t){e.addFunction(t)};this.addDialog.addingCallback=function(t){e.addingFunction(t)};this.addDialog.listSelectFieldWhereFunction=function(t){return e.listSelectFieldWhere(t)}}if(this.dataFormFunction!=null){this.dataFormFunction(this.addDialog.dataForm)}setTimeout(function(){l.Util.appendDisplayObject(document.body,e.addDialog);e.addDialog.showDialog(true)},1)};t.prototype.addFunction=function(t){for(var e=0;e<t.childNodes.length;e++){var i=t.childNodes.item(e);if(i.nodeType==1){this.control.addItemByXmlDataProvider(i,this.control.items)}}this.control.selectedItem=this.control.items.getItemAt(this.control.items.count-1);var o=new c.FxMVVMEvent;o.type=c.FxMVVMEvent.Added;o.target=this;o.item=this.control.selectedItem;o.items=this.control.items;o.xml=t.ownerDocument;this.dispatchEvent(o);s.Progress.hide()};t.prototype.addingFunction=function(t){for(var e=0;e<this.additionalData.keys.length;e++){var i=this.additionalData.keys[e];var o=this.additionalData.getValue(i);t.setAttribute(i,o)}};t.prototype.editFunction=function(t){for(var e=0;e<t.childNodes.length;e++){var i=t.childNodes.item(e);if(i.nodeType==1){var o=new c.FxMVVMEvent;o.item=this.control.selectedItem;this.control.setItemXmlDataProvider(i,this.control.selectedItem);s.Progress.hide();o.type=c.FxMVVMEvent.Edited;o.target=this;o.items=this.control.items;o.xml=t.ownerDocument;this.dispatchEvent(o);return}}};Object.defineProperty(t.prototype,"additionalData",{get:function(){return this._additionalData},set:function(t){this._additionalData=t},enumerable:true,configurable:true});t.prototype.listSelectFieldWhere=function(t){if(this.listSelectFieldWhereFunction!=null){return this.listSelectFieldWhereFunction(t)}else{return""}};return t}(i.ListDataView);e.ListDataEditor=a});